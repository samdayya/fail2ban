# fail2ban script

Script per mostrar totes les IP bloquejades de tots els jails de fail2ban amb timestamps en format humà i geolocalització

En aquest cas mostrarem el port 445

![fail2ban](https://github.com/user-attachments/assets/c14c21fb-6906-4791-8078-968b5be27b05)

## Configurem `iptables.md` per permetre algunes `IP's` a diversos ports. Essencialment, `445`
>/root/iptables.md

```
### Generated by localhost store© iptables 2011-2025
*filter
## INPUT DROP EVERYTHING BY DEFAULT
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:f2b-sshd - [0:0]
-A INPUT -p tcp -m multiport --dports 22 -j f2b-sshd

### ALLOW LAN CONNECTION
-A INPUT -s 192.168.0.0/24      -p tcp --dport 22            -j ACCEPT
-A INPUT -s 192.168.0.0/24      -p tcp --dport 80            -j ACCEPT
-A INPUT -s 192.168.0.0/24      -p tcp --dport 445           -j ACCEPT

### ALLOW GIVEN INTERNET CUSTOMERS IP's
-A INPUT -s X.X.X.X/32    -p tcp --dport 445                 -j ACCEPT

### IF F2B HAS NOTHING MORE TO DO, CONTINUE
-A f2b-sshd -j RETURN

### ALLOW PING REQUEST
-A INPUT -s 10.0.0.0/24     -p icmp --icmp-type echo-request -j ACCEPT
-A INPUT -s 192.168.0.0/24  -p icmp --icmp-type echo-request -j ACCEPT

### ALLOW LOOPBACK CONNECTIONS
-A INPUT -i lo -j ACCEPT

### ALLOW ESTABLISHED AND RELATED CONNECTIONS
-A INPUT -m conntrack --ctstate ESTABLISHED                  -j ACCEPT

### LOGGING FOR DROPPED PACKETS (we will read this log later using fail2ban)
-A INPUT -j LOG --log-prefix "DROP INPUT: " --log-level 4

### DROP EVERYTHING ELSE
-A INPUT                                                      -j DROP

COMMIT
```


## Configurem un `FILTRE` i una `JAIL` al `fail2ban` . Essencialment, `445`
> /etc/fail2ban/filter.d/iptables-drop.conf

```
[Definition]
failregex = DROP INPUT: .*SRC=<HOST> DST=192\.168\.0\.156.*DPT=445
ignoreregex =
```
