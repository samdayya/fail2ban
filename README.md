# fail2ban script

Script per mostrar totes les IP bloquejades de tots els jails de fail2ban amb timestamps en format humà i geolocalització

En aquest cas mostrarem el port 445

![fail2ban](https://github.com/user-attachments/assets/c14c21fb-6906-4791-8078-968b5be27b05)

#### Configurem `iptables.md` per permetre algunes `IP's` a diversos ports.
#### Essencialment, `445`
>/root/iptables.md

```
### Generated by localhost store© iptables 2011-2025
*filter
## INPUT DROP EVERYTHING BY DEFAULT
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:f2b-sshd - [0:0]
-A INPUT -p tcp -m multiport --dports 22 -j f2b-sshd

### ALLOW LAN CONNECTION
-A INPUT -s 192.168.0.0/24      -p tcp --dport 22            -j ACCEPT
-A INPUT -s 192.168.0.0/24      -p tcp --dport 80            -j ACCEPT
-A INPUT -s 192.168.0.0/24      -p tcp --dport 445           -j ACCEPT

### ALLOW GIVEN INTERNET CUSTOMERS IP's
-A INPUT -s X.X.X.X/32    -p tcp --dport 445                 -j ACCEPT

### IF F2B HAS NOTHING MORE TO DO, CONTINUE
-A f2b-sshd -j RETURN

### ALLOW PING REQUEST
-A INPUT -s 10.0.0.0/24     -p icmp --icmp-type echo-request -j ACCEPT
-A INPUT -s 192.168.0.0/24  -p icmp --icmp-type echo-request -j ACCEPT

### ALLOW LOOPBACK CONNECTIONS
-A INPUT -i lo -j ACCEPT

### ALLOW ESTABLISHED AND RELATED CONNECTIONS
-A INPUT -m conntrack --ctstate ESTABLISHED                  -j ACCEPT

### LOGGING FOR DROPPED PACKETS (we will read this log later using fail2ban)
-A INPUT -j LOG --log-prefix "DROP INPUT: " --log-level 4

### DROP EVERYTHING ELSE
-A INPUT                                                      -j DROP

COMMIT
```

#### Configurem el `FILTRE` al `fail2ban` amb destí al servidor a protegir.
#### En aquest cas 192.168.0.156 amb port 445
> /etc/fail2ban/filter.d/iptables-drop.conf

```
[Definition]
failregex = DROP INPUT: .*SRC=<HOST> DST=192\.168\.0\.156.*DPT=445
ignoreregex =
```

#### Configurem un `JAIL` al `fail2ban`.
* Aquest llegirà els registres emesos per iptables...
* -A INPUT -j LOG --log-prefix "DROP INPUT: " --log-level 4
* ...emmagatzemats al syslog.
* Configuració segons estàndard ZEROTRUST
> /etc/fail2ban/filter.d/iptables-drop.conf

```
[iptables-drop]
enabled = true
port = 445
filter = iptables-drop
logpath = /var/log/syslog
maxretry = 1
bantime = -1  ; Bloqueig permanent
```

#### Finalment, l'script:
> /root/fail2ban.sh

```
#!/bin/bash

# Script per mostrar totes les IP bloquejades de tots els jails de Fail2ban amb timestamps en format humà i geolocalització

# Accedir a la base de dades SQLite
db_path="/var/lib/fail2ban/fail2ban.sqlite3"

# Verificar si la base de dades existeix
if [ ! -f "$db_path" ]; then
    echo "La base de dades de Fail2ban no existeix a $db_path"
    exit 1
fi

# Funció per obtenir la informació geogràfica de l'IP
get_geo_info() {
    local ip="$1"
    local geo_info=$(curl -s "https://ipinfo.io/$ip/json")

    if [ $? -eq 0 ]; then
        echo "$geo_info" | jq -r '.country, .region, .city'
    else
        echo "Desconegut"
    fi
}

# Encapsular la consulta a SQLite
result=$(sqlite3 "$db_path" "SELECT jail, ip, timeofban, bantime FROM bans;")

# Comprovar si s'han obtingut resultats
if [ -z "$result" ]; then
    echo "No hi ha IP bloquejades."
    exit 0
fi

# Mostrar capçalera
printf "%-20s %-20s %-25s %-10s %-10s %-20s %-10s\n" "Jail" "IP" "Time of Ban" "Ban Time" "Country" "Region" "City"
echo "------------------------------------"

# Processar els resultats
echo "$result" | while IFS='|' read -r jail ip timeofban bantime; do
    # Convertir el timestamp a format humà
    human_time=$(date -d @"$timeofban" +"%Y-%m-%d %H:%M:%S")

    # Obtenir informació geogràfica de l'IP
    geo_info=$(get_geo_info "$ip")

    # Separar la informació geogràfica
    country=$(echo "$geo_info" | awk 'NR==1 {print}')
    region=$(echo "$geo_info" | awk 'NR==2 {print}')
    city=$(echo "$geo_info" | awk 'NR==3 {print}')

    # Mostrar resultats amb alineació
    printf "%-20s %-20s %-25s %-10s %-10s %-20s %-10s\n" "$jail" "$ip" "$human_time" "$bantime" "$country" "$region" "$city"
done
```

#### Donem-li permisos
```
chmod +x /root/fail2ban.sh
```

#### Opcionalment:
```
alias fail='/root/fail2ban.sh'
```
